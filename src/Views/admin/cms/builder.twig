{% extends "layout.twig" %}

{% block title %}{{ title }} - {{ app_name }}{% endblock %}

{% block styles %}
<style>
    body { background: #f8f9fa; overflow: hidden; }
    /* Override main layout constraints for the builder */
    main {
        max-width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    footer { display: none; }
    
    .builder-layout {
        display: grid;
        grid-template-columns: 280px 1fr 340px;
        height: calc(100vh - 64px); /* Header height is about 64px */
        background: #ddd;
    }
    .builder-sidebar, .builder-settings {
        background: white;
        padding: 1.5rem;
        overflow-y: auto;
        box-shadow: 0 0 10px rgba(0,0,0,0.05);
        z-index: 10;
    }
    .builder-canvas {
        background: #f1f1f1;
        padding: 0;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
    }
    #canvas-container {
        background: white;
        width: 100%;
        min-height: 100%;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
        transition: width 0.3s;
        margin: 0 auto;
    }
    
    /* Responsive Canvas Sizes */
    .canvas-desktop { width: 100% !important; }
    .canvas-tablet { width: 768px !important; }
    .canvas-mobile { width: 375px !important; }

    /* Block UI */
    .block-item {
        padding: 1rem;
        border: 2px dashed transparent;
        position: relative;
        cursor: pointer;
    }
    .block-item:hover { border-color: #3498db; }
    .block-item.active { border-color: #3498db; background: rgba(52, 152, 219, 0.05); }
    
    .block-actions {
        position: absolute;
        right: 0;
        top: 0;
        display: none;
        background: #3498db;
        color: white;
        padding: 2px 5px;
        font-size: 10px;
        z-index: 10;
    }
    .block-item:hover .block-actions { display: block; }

    /* Tooltip-like Form Controls */
    .form-group { margin-bottom: 1.25rem; }
    .form-group label {
        display: block;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        color: #64748b;
        margin-bottom: 0.5rem;
        letter-spacing: 0.025em;
    }
    .form-control {
        width: 100%;
        padding: 0.6rem 0.8rem;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.9rem;
        background: #f8fafc;
        transition: all 0.2s;
        color: #1e293b;
    }
    .form-control:focus {
        outline: none;
        border-color: #3498db;
        background: white;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    .color-input-wrapper {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #f8fafc;
        padding: 5px 10px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
    }
    .color-preview {
        width: 30px;
        height: 30px;
        border-radius: 4px;
        border: 1px solid #ddd;
        flex-shrink: 0;
    }
    .color-input-field {
        border: none;
        background: transparent;
        width: 100%;
        font-size: 0.9rem;
        outline: none;
    }

    /* Tabs per Responsivit√† */
    .responsive-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 2.5rem;
        background: #f1f5f9;
        padding: 8px;
        border-radius: 16px;
        border: 1px solid #e2e8f0;
    }
    .tab-btn {
        flex: 1;
        border: none;
        padding: 16px 8px;
        background: transparent;
        cursor: pointer;
        border-radius: 12px;
        font-size: 1.8rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        color: #94a3b8;
    }
    .tab-btn:hover { background: white; color: #3498db; }
    .tab-btn.active { 
        background: white; 
        color: #3498db;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    /* Buttons */
    .builder-actions {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-top: 1.5rem;
    }
    .btn-save {
        padding: 0.8rem;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    .btn-save:hover { background: #2980b9; transform: translateY(-1px); }
    .btn-save:active { transform: translateY(0); }

    .btn-exit {
        padding: 0.8rem;
        background: #f1f5f9;
        color: #64748b;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        text-align: center;
        transition: all 0.2s;
        border: 1px solid #e2e8f0;
    }
    .btn-exit:hover { background: #e2e8f0; color: #1e293b; }

    .btn-publish {
        padding: 0.8rem;
        background: #10b981;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: 100%;
    }
    .btn-publish:hover { background: #059669; transform: translateY(-1px); }
    .btn-publish:active { transform: translateY(0); }

    .btn-draft {
        padding: 0.8rem;
        background: #f39c12;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: 100%;
    }
    .btn-draft:hover { background: #e67e22; transform: translateY(-1px); }
    .btn-draft:active { transform: translateY(0); }

    .btn-preview {
        padding: 0.8rem;
        background: #8b5cf6;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: 100%;
        text-decoration: none;
    }
    .btn-preview:hover { background: #7c3aed; transform: translateY(-1px); }
    .btn-preview:active { transform: translateY(0); }

    /* Checkbox Styling */
    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-bottom: 0.75rem;
    }
    .checkbox-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #3498db;
    }
    .checkbox-group label {
        margin: 0;
        font-size: 0.9rem;
        cursor: pointer;
        flex: 1;
    }

    /* Range Slider */
    .range-slider {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .range-slider input[type="range"] {
        flex: 1;
        height: 6px;
        border-radius: 3px;
        background: #e2e8f0;
        outline: none;
        -webkit-appearance: none;
    }
    .range-slider input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #3498db;
        cursor: pointer;
    }
    .range-slider input[type="range"]::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #3498db;
        cursor: pointer;
        border: none;
    }
    .range-value {
        min-width: 60px;
        text-align: right;
        font-weight: 600;
        color: #1e293b;
        font-size: 0.9rem;
    }

    /* Google Fonts Link */
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Poppins:wght@300;400;500;700&family=Inter:wght@300;400;500;700&family=Playfair+Display:wght@400;700&display=swap');

    /* Notification System */
    .notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        display: none;
        z-index: 1000;
        font-weight: 600;
        animation: slideUp 0.3s ease-out;
        max-width: 400px;
        min-width: 300px;
    }
    .notification.show { display: block; }
    .notification.success {
        background: #10b981;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    .notification.error {
        background: #ef4444;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    .notification.info {
        background: #3498db;
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }
    .notification.warning {
        background: #f39c12;
        box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
    }
    .notification-title {
        font-weight: 700;
        margin-bottom: 5px;
    }
    .notification-message {
        font-size: 0.9rem;
        line-height: 1.4;
    }
    @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    /* Hero Block Styles */
    .hero-block-preview {
        display: flex;
        gap: 20px;
        align-items: stretch;
        width: 100%;
    }
    .hero-block-preview.image-left {
        flex-direction: row;
    }
    .hero-block-preview.image-right {
        flex-direction: row-reverse;
    }
    .hero-block-preview.image-top {
        flex-direction: column;
    }
    .hero-block-preview.image-bottom {
        flex-direction: column-reverse;
    }
    
    .hero-image {
        flex: 1;
        min-width: 0;
        border-radius: 4px;
        object-fit: cover;
    }
    
    .hero-text-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    .hero-title {
        margin: 0 0 15px 0;
        font-weight: 700;
        line-height: 1.2;
    }
    
    .hero-subtitle {
        margin: 0 0 20px 0;
        line-height: 1.5;
    }
    
    .hero-button {
        display: inline-block;
        padding: 12px 24px;
        border-radius: 4px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.2s;
        border: none;
        cursor: pointer;
        width: fit-content;
    }
    
    .hero-button:hover {
        opacity: 0.9;
        transform: translateY(-1px);
    }
</style>
{% endblock %}

{% block content %}
<script src="https://cdn.tiny.cloud/1/{{ tinymce_api_key }}/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
<script src="/js/builder-tests.js"></script>

<div class="builder-layout">
    <!-- Sidebar: Blocchi Disponibili -->
    <div class="builder-sidebar">
        <h3 style="margin-bottom: 1.5rem; color: #1e293b;">Componenti</h3>
        <div id="tools">
            <div class="tool-item" data-type="title" style="padding: 1rem; background: #f8fafc; border: 1px solid #e2e8f0; margin-bottom: 0.75rem; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 1rem; transition: all 0.2s;">
                <span style="font-size: 1.5rem;">üî§</span> 
                <span style="font-weight: 600; color: #475569;">Titolo</span>
            </div>
            <div class="tool-item" data-type="text" style="padding: 1rem; background: #f8fafc; border: 1px solid #e2e8f0; margin-bottom: 0.75rem; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 1rem; transition: all 0.2s;">
                <span style="font-size: 1.5rem;">üìÑ</span> 
                <span style="font-weight: 600; color: #475569;">Testo</span>
            </div>
            <div class="tool-item" data-type="image" style="padding: 1rem; background: #f8fafc; border: 1px solid #e2e8f0; margin-bottom: 0.75rem; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 1rem; transition: all 0.2s;">
                <span style="font-size: 1.5rem;">üñºÔ∏è</span> 
                <span style="font-weight: 600; color: #475569;">Immagine</span>
            </div>
            <div class="tool-item" data-type="hero" style="padding: 1rem; background: #f8fafc; border: 1px solid #e2e8f0; margin-bottom: 0.75rem; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 1rem; transition: all 0.2s;">
                <span style="font-size: 1.5rem;">ü¶∏</span> 
                <span style="font-weight: 600; color: #475569;">Hero Section</span>
            </div>
        </div>
        <hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">
        
        <!-- Pagina Settings -->
        <div style="margin-bottom: 1.5rem;">
            <h4 style="color: #1e293b; margin-bottom: 1rem; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.025em;">Impostazioni Pagina</h4>
            <div class="checkbox-group">
                <input type="checkbox" id="set-homepage" />
                <label for="set-homepage">Imposta come homepage</label>
            </div>
        </div>

        <div class="builder-actions">
            <button id="publish-btn" class="btn-publish" data-status="{{ page.status }}" data-is-homepage="{{ page.isHomepage ? '1' : '0' }}">
                <span id="publish-icon">üì§</span> <span id="publish-text">{{ page.status == 'published' ? 'Metti in Bozza' : 'Pubblica Pagina' }}</span>
            </button>
            <button id="save-btn" class="btn-save">
                <span>üíæ</span> Salva Pagina
            </button>
            <a id="preview-btn" class="btn-preview" target="_blank">
                <span>üëÅÔ∏è</span> Anteprima
            </a>
            <a href="/admin/cms" class="btn-exit">Esci</a>
        </div>
    </div>

    <!-- Canvas: Anteprima Live -->
    <div class="builder-canvas">
        <div id="canvas-container" class="canvas-desktop">
            <div id="canvas" style="min-height: 500px; padding: 1rem;">
                <!-- I blocchi verranno renderizzati qui via JS -->
            </div>
        </div>
    </div>

    <!-- Settings: Configurazione Blocco Selezionato -->
    <div class="builder-settings">
        <div id="settings-blank" style="color: #94a3b8; text-align: center; margin-top: 5rem;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">‚ú®</div>
            <p>Seleziona un blocco per modificarlo</p>
        </div>
        <div id="settings-form" style="display: none;">
            <div class="responsive-tabs">
                <button class="tab-btn active" data-view="desktop" title="Desktop">üñ•Ô∏è</button>
                <button class="tab-btn" data-view="tablet" title="Tablet">üìü</button>
                <button class="tab-btn" data-view="mobile" title="Mobile">üì±</button>
            </div>
            <h4 id="editing-block-type" style="margin-bottom: 1.5rem; color: #1e293b; border-bottom: 2px solid #3498db; display: inline-block; padding-bottom: 0.25rem;">Modifica Blocco</h4>
            <div id="fields-container">
                <!-- I campi dinamici verranno inseriti qui -->
            </div>
        </div>
    </div>
</div>

<div id="save-status" class="notification"></div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    // Notification System
    function notify(type, title, message, duration = 4000) {
        const notif = document.getElementById('save-status');
        notif.className = 'notification show ' + type;
        notif.innerHTML = `
            <div class="notification-title">${title}</div>
            <div class="notification-message">${message}</div>
        `;
        
        setTimeout(() => {
            notif.classList.remove('show');
        }, duration);
    }
    
    // Variabili Globali
    const pageId = {{ page.id }};
    const pageSlug = '{{ page.slug }}';
    let pageStatus = '{{ page.status }}';
    let isHomepage = {{ page.isHomepage ? 'true' : 'false' }};
    const canvas = document.getElementById('canvas');
    const settingsForm = document.getElementById('settings-form');
    const settingsBlank = document.getElementById('settings-blank');
    const fieldsContainer = document.getElementById('fields-container');
    const canvasContainer = document.getElementById('canvas-container');
    
    // Imposta l'href del bottone anteprima
    document.getElementById('preview-btn').href = '/p/' + pageSlug;
    
    let blocks = {{ page.blocksJson|default('[]')|raw }};
    let activeBlockIndex = null;
    let currentView = 'desktop';

    // Font Families Disponibili (con pesi supportati)
    const fonts = {
        roboto: { family: 'Roboto, sans-serif', weights: [300, 400, 500, 700] },
        poppins: { family: 'Poppins, sans-serif', weights: [300, 400, 500, 700] },
        inter: { family: 'Inter, sans-serif', weights: [300, 400, 500, 700] },
        playfair: { family: '"Playfair Display", serif', weights: [400, 700] }
    };

    function getFontFamily(fontKey) {
        return fonts[fontKey]?.family || fonts.roboto.family;
    }

    function getAvailableWeights(fontKey) {
        return fonts[fontKey]?.weights || fonts.roboto.weights;
    }

    // Inizializzazione Builder
    function init() {
        // Aggiorna classe pulsante publish in base allo stato
        const publishBtn = document.getElementById('publish-btn');
        if (pageStatus === 'published') {
            publishBtn.classList.remove('btn-publish');
            publishBtn.classList.add('btn-draft');
        }
        
        // Disabilita il checkbox homepage se la pagina √® gi√† homepage
        const homepageCheckbox = document.getElementById('set-homepage');
        if (isHomepage) {
            homepageCheckbox.checked = true;
            homepageCheckbox.disabled = true;
        }
        
        renderCanvas();
        
        // Drag and Drop (Sortable)
        new Sortable(canvas, {
            animation: 150,
            onEnd: (evt) => {
                const movedBlock = blocks.splice(evt.oldIndex, 1)[0];
                blocks.splice(evt.newIndex, 0, movedBlock);
                renderCanvas();
            }
        });

        // Click sui tool per aggiungere blocchi
        document.querySelectorAll('.tool-item').forEach(item => {
            item.addEventListener('click', () => {
                addBlock(item.dataset.type);
            });
        });

        // Tabs Responsivit√†
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentView = btn.dataset.view;
                
                // Cambia dimensione canvas
                canvasContainer.className = '';
                canvasContainer.classList.add('canvas-' + currentView);
                
                if (activeBlockIndex !== null) openSettings(activeBlockIndex);
            });
        });

        // Salva
        document.getElementById('save-btn').addEventListener('click', savePage);

        // Pubblica
        document.getElementById('publish-btn').addEventListener('click', publishPage);

        // Homepage checkbox
        document.getElementById('set-homepage').addEventListener('change', (e) => {
            if (e.target.checked) {
                setHomepage();
            }
        });
    }

    function addBlock(type) {
        let newBlock = {};
        
        if (type === 'hero') {
            newBlock = {
                type: 'hero',
                content: {
                    title: "Titolo Hero",
                    subtitle: "Sottotitolo opzionale",
                    buttonText: "Clicca qui",
                    buttonLink: "#",
                    imageUrl: "https://via.placeholder.com/600x400?text=Scegli+Immagine",
                    imagePosition: "right" // left, right, top, bottom
                },
                settings: {
                    desktop: {
                        title_font_family: "roboto",
                        title_font_size: "48px",
                        title_font_weight: "700",
                        title_letter_spacing: "0px",
                        title_color: "#000000",
                        title_align: "left",
                        title_show: true,
                        
                        subtitle_font_family: "roboto",
                        subtitle_font_size: "18px",
                        subtitle_font_weight: "400",
                        subtitle_letter_spacing: "0px",
                        subtitle_color: "#666666",
                        subtitle_align: "left",
                        subtitle_show: true,
                        
                        button_font_family: "roboto",
                        button_font_size: "16px",
                        button_font_weight: "600",
                        button_color: "#ffffff",
                        button_bg_color: "#ff9800",
                        button_show: true,
                        
                        padding: "40px",
                        image_gap: "40px"
                    },
                    tablet: {},
                    mobile: {}
                }
            };
        } else {
            newBlock = {
                type: type,
                content: { text: "Nuovo " + type },
                settings: {
                    desktop: { 
                        font_family: "roboto",
                        font_size: "18px",
                        font_weight: "400",
                        letter_spacing: "0px",
                        word_spacing: "0px",
                        color: "#333333",
                        padding: "10px",
                        align: "left"
                    },
                    tablet: {},
                    mobile: {}
                }
            };
        }
        
        blocks.push(newBlock);
        renderCanvas();
        openSettings(blocks.length - 1);
    }

    function renderCanvas() {
        canvas.innerHTML = '';
        blocks.forEach((block, index) => {
            const div = document.createElement('div');
            div.className = 'block-item' + (activeBlockIndex === index ? ' active' : '');
            
            // Applica stili (prendendo dalla cascata Desktop -> Tablet -> Mobile se mancanti?)
            const styles = getStylesForView(block, currentView);
            const fontFamily = getFontFamily(styles.font_family || 'roboto');
            
            div.style.cssText = `
                color: ${styles.color || '#333'};
                font-family: ${fontFamily};
                font-size: ${styles.font_size || '1rem'};
                font-weight: ${styles.font_weight || '400'};
                letter-spacing: ${styles.letter_spacing || '0px'};
                word-spacing: ${styles.word_spacing || '0px'};
                padding: ${styles.padding || '0'};
                text-align: ${styles.align || 'left'};
            `;

            div.innerHTML = `
                <div class="block-actions">#${index+1} ${block.type}</div>
                ${renderBlockPreview(block)}
            `;
            
            div.onclick = (e) => {
                e.stopPropagation();
                openSettings(index);
            };
            
            canvas.appendChild(div);
        });
    }

    function renderBlockPreview(block) {
        if (block.type === 'image') {
            const url = block.content.url || 'https://via.placeholder.com/600x300?text=Scegli+Immagine';
            return `<img src="${url}" style="max-width: 100%; display: block; border-radius: 4px;">`;
        }
        if (block.type === 'hero') {
            const content = block.content;
            const styles = getStylesForView(block, 'desktop');
            const imageUrl = content.imageUrl || 'https://via.placeholder.com/600x400?text=Immagine';
            
            const textBlock = `
                <div style="flex: 1;">
                    ${content.title ? `<h2 style="margin: 0 0 10px 0; font-size: 32px; font-weight: 700; color: #000;">${content.title}</h2>` : ''}
                    ${content.subtitle ? `<p style="margin: 0 0 20px 0; font-size: 16px; color: #666;">${content.subtitle}</p>` : ''}
                    ${content.buttonText ? `<a href="${content.buttonLink}" style="display: inline-block; padding: 10px 20px; background-color: #ff9800; color: white; border-radius: 4px; text-decoration: none; font-weight: 600;">${content.buttonText}</a>` : ''}
                </div>
            `;
            
            const imgBlock = `<img src="${imageUrl}" style="flex: 1; max-width: 100%; border-radius: 4px;">`;
            
            let layout = imgBlock + textBlock;
            if (content.imagePosition === 'left' || content.imagePosition === 'right') {
                layout = content.imagePosition === 'right' ? textBlock + imgBlock : imgBlock + textBlock;
            } else if (content.imagePosition === 'top') {
                layout = imgBlock + textBlock;
            } else if (content.imagePosition === 'bottom') {
                layout = textBlock + imgBlock;
            }
            
            const flexDir = (content.imagePosition === 'left' || content.imagePosition === 'right') ? 'row' : 'column';
            const flexWrap = (content.imagePosition === 'left' || content.imagePosition === 'right') ? 'nowrap' : 'wrap';
            
            return `
                <div style="display: flex; flex-direction: ${flexDir}; gap: 20px; align-items: center;">
                    ${layout}
                </div>
            `;
        }
        return `<div style="min-height: 1.2em;">${block.content.text || '(Vuoto)'}</div>`;
    }

    function getStylesForView(block, view) {
        // Fallback progressivo: Mobile -> Tablet -> Desktop
        const desk = block.settings.desktop || {};
        const tab = block.settings.tablet || {};
        const mob = block.settings.mobile || {};

        if (view === 'desktop') return desk;
        if (view === 'tablet') return { ...desk, ...tab };
        if (view === 'mobile') return { ...desk, ...tab, ...mob };
    }

    function openSettings(index) {
        activeBlockIndex = index;
        const block = blocks[index];
        settingsBlank.style.display = 'none';
        settingsForm.style.display = 'block';
        document.getElementById('editing-block-type').innerText = 'Modifica ' + block.type;
        
        fieldsContainer.innerHTML = '';
        
        // HERO BLOCK SPECIAL HANDLING
        if (block.type === 'hero') {
            // Sezione Contenuto
            const contentSection = document.createElement('div');
            contentSection.innerHTML = '<h4 style="margin-top: 0; margin-bottom: 15px; font-size: 14px; font-weight: 600; color: #555;">üìù Contenuto</h4>';
            fieldsContainer.appendChild(contentSection);
            
            // Titolo
            const titleGroup = document.createElement('div');
            titleGroup.className = 'form-group';
            const titleLabel = document.createElement('label');
            titleLabel.innerText = 'Titolo';
            const titleInput = document.createElement('input');
            titleInput.type = 'text';
            titleInput.className = 'form-control';
            titleInput.value = block.content.title || '';
            titleInput.oninput = (e) => {
                block.content.title = e.target.value;
                renderCanvas();
            };
            titleGroup.appendChild(titleLabel);
            titleGroup.appendChild(titleInput);
            fieldsContainer.appendChild(titleGroup);
            
            // Sottotitolo con toggle
            const subtitleGroup = document.createElement('div');
            subtitleGroup.className = 'form-group';
            const subtitleLabel = document.createElement('label');
            subtitleLabel.style.display = 'flex';
            subtitleLabel.style.alignItems = 'center';
            subtitleLabel.style.gap = '8px';
            const subtitleCheckbox = document.createElement('input');
            subtitleCheckbox.type = 'checkbox';
            subtitleCheckbox.checked = block.content.subtitle ? true : false;
            subtitleCheckbox.onchange = (e) => {
                const currentVal = block.content.subtitle;
                block.content.subtitle = e.target.checked ? (currentVal || 'Sottotitolo opzionale') : '';
                renderCanvas();
            };
            subtitleLabel.appendChild(subtitleCheckbox);
            subtitleLabel.appendChild(document.createTextNode('Mostra Sottotitolo'));
            subtitleGroup.appendChild(subtitleLabel);
            
            if (block.content.subtitle) {
                const subtitleInput = document.createElement('textarea');
                subtitleInput.className = 'form-control';
                subtitleInput.style.minHeight = '60px';
                subtitleInput.value = block.content.subtitle || '';
                subtitleInput.oninput = (e) => {
                    block.content.subtitle = e.target.value;
                    renderCanvas();
                };
                subtitleGroup.appendChild(subtitleInput);
            }
            fieldsContainer.appendChild(subtitleGroup);
            
            // Immagine
            const imageGroup = document.createElement('div');
            imageGroup.className = 'form-group';
            const imageLabel = document.createElement('label');
            imageLabel.innerText = 'Immagine';
            const imageInput = document.createElement('input');
            imageInput.type = 'text';
            imageInput.className = 'form-control';
            imageInput.value = block.content.imageUrl || '';
            imageInput.oninput = (e) => {
                block.content.imageUrl = e.target.value;
                renderCanvas();
            };
            imageGroup.appendChild(imageLabel);
            imageGroup.appendChild(imageInput);
            
            const uploadBtn = document.createElement('input');
            uploadBtn.type = 'file';
            uploadBtn.style.marginTop = '10px';
            uploadBtn.style.fontSize = '0.8rem';
            uploadBtn.onchange = (e) => handleUpload(e, index);
            imageGroup.appendChild(uploadBtn);
            fieldsContainer.appendChild(imageGroup);
            
            // Posizionamento Immagine
            const posGroup = document.createElement('div');
            posGroup.className = 'form-group';
            const posLabel = document.createElement('label');
            posLabel.innerText = 'Posizione Immagine';
            const posSelect = document.createElement('select');
            posSelect.className = 'form-control';
            const positions = [
                { value: 'left', label: '‚¨ÖÔ∏è Sinistra (testo destra)' },
                { value: 'right', label: '‚û°Ô∏è Destra (testo sinistra)' },
                { value: 'top', label: '‚¨ÜÔ∏è Sopra (testo sotto)' },
                { value: 'bottom', label: '‚¨áÔ∏è Sotto (testo sopra)' }
            ];
            positions.forEach(pos => {
                const opt = document.createElement('option');
                opt.value = pos.value;
                opt.innerText = pos.label;
                opt.selected = block.content.imagePosition === pos.value;
                posSelect.appendChild(opt);
            });
            posSelect.oninput = (e) => {
                block.content.imagePosition = e.target.value;
                renderCanvas();
            };
            posGroup.appendChild(posLabel);
            posGroup.appendChild(posSelect);
            fieldsContainer.appendChild(posGroup);
            
            // Bottone con toggle
            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'form-group';
            const buttonLabel = document.createElement('label');
            buttonLabel.style.display = 'flex';
            buttonLabel.style.alignItems = 'center';
            buttonLabel.style.gap = '8px';
            const buttonCheckbox = document.createElement('input');
            buttonCheckbox.type = 'checkbox';
            buttonCheckbox.checked = block.content.buttonText ? true : false;
            buttonCheckbox.onchange = (e) => {
                const currentVal = block.content.buttonText;
                block.content.buttonText = e.target.checked ? (currentVal || 'Clicca qui') : '';
                renderCanvas();
            };
            buttonLabel.appendChild(buttonCheckbox);
            buttonLabel.appendChild(document.createTextNode('Mostra Bottone'));
            buttonGroup.appendChild(buttonLabel);
            
            if (block.content.buttonText) {
                const buttonTextInput = document.createElement('input');
                buttonTextInput.type = 'text';
                buttonTextInput.className = 'form-control';
                buttonTextInput.placeholder = 'Testo bottone';
                buttonTextInput.value = block.content.buttonText || '';
                buttonTextInput.oninput = (e) => {
                    block.content.buttonText = e.target.value;
                    renderCanvas();
                };
                buttonGroup.appendChild(buttonTextInput);
                
                const buttonLinkInput = document.createElement('input');
                buttonLinkInput.type = 'text';
                buttonLinkInput.className = 'form-control';
                buttonLinkInput.placeholder = 'Link bottone (es: #, /pagina, https://...)';
                buttonLinkInput.value = block.content.buttonLink || '';
                buttonLinkInput.oninput = (e) => {
                    block.content.buttonLink = e.target.value;
                    renderCanvas();
                };
                buttonGroup.appendChild(buttonLinkInput);
            }
            fieldsContainer.appendChild(buttonGroup);
            
            fieldsContainer.appendChild(document.createElement('hr'));
            
            // Sezione Styling
            const styleSection = document.createElement('div');
            styleSection.innerHTML = '<h4 style="margin-top: 0; margin-bottom: 15px; font-size: 14px; font-weight: 600; color: #555;">üé® Stile - Titolo</h4>';
            fieldsContainer.appendChild(styleSection);
            
            const currentStyles = block.settings[currentView] || {};
            
            // Titolo styling
            addStyleField('Font Family Titolo', 'title_font_family', 'select', currentStyles.title_font_family || 'roboto', Object.keys(fonts));
            const titleFontKey = currentStyles.title_font_family || 'roboto';
            const titleWeights = getAvailableWeights(titleFontKey);
            addStyleField('Font Weight Titolo', 'title_font_weight', 'select', currentStyles.title_font_weight || '700', titleWeights.map(String));
            addStyleFieldWithRange('Dimensione Titolo', 'title_font_size', currentStyles.title_font_size || '48px', 24, 96);
            addStyleField('Letter Spacing Titolo', 'title_letter_spacing', 'text', currentStyles.title_letter_spacing || '0px');
            addStyleField('Colore Titolo', 'title_color', 'color', currentStyles.title_color || '#000000');
            addStyleField('Allineamento Titolo', 'title_align', 'select', currentStyles.title_align || 'left', ['left', 'center', 'right']);
            
            // Sottotitolo styling
            const subtitleStyleSection = document.createElement('div');
            subtitleStyleSection.innerHTML = '<h4 style="margin-top: 20px; margin-bottom: 15px; font-size: 14px; font-weight: 600; color: #555;">üé® Stile - Sottotitolo</h4>';
            fieldsContainer.appendChild(subtitleStyleSection);
            
            addStyleField('Font Family Sottotitolo', 'subtitle_font_family', 'select', currentStyles.subtitle_font_family || 'roboto', Object.keys(fonts));
            const subtitleFontKey = currentStyles.subtitle_font_family || 'roboto';
            const subtitleWeights = getAvailableWeights(subtitleFontKey);
            addStyleField('Font Weight Sottotitolo', 'subtitle_font_weight', 'select', currentStyles.subtitle_font_weight || '400', subtitleWeights.map(String));
            addStyleFieldWithRange('Dimensione Sottotitolo', 'subtitle_font_size', currentStyles.subtitle_font_size || '18px', 12, 48);
            addStyleField('Letter Spacing Sottotitolo', 'subtitle_letter_spacing', 'text', currentStyles.subtitle_letter_spacing || '0px');
            addStyleField('Colore Sottotitolo', 'subtitle_color', 'color', currentStyles.subtitle_color || '#666666');
            addStyleField('Allineamento Sottotitolo', 'subtitle_align', 'select', currentStyles.subtitle_align || 'left', ['left', 'center', 'right']);
            
            // Bottone styling
            const buttonStyleSection = document.createElement('div');
            buttonStyleSection.innerHTML = '<h4 style="margin-top: 20px; margin-bottom: 15px; font-size: 14px; font-weight: 600; color: #555;">üé® Stile - Bottone</h4>';
            fieldsContainer.appendChild(buttonStyleSection);
            
            addStyleField('Font Family Bottone', 'button_font_family', 'select', currentStyles.button_font_family || 'roboto', Object.keys(fonts));
            const buttonFontKey = currentStyles.button_font_family || 'roboto';
            const buttonWeights = getAvailableWeights(buttonFontKey);
            addStyleField('Font Weight Bottone', 'button_font_weight', 'select', currentStyles.button_font_weight || '600', buttonWeights.map(String));
            addStyleFieldWithRange('Dimensione Bottone', 'button_font_size', currentStyles.button_font_size || '16px', 12, 32);
            addStyleField('Colore Testo Bottone', 'button_color', 'color', currentStyles.button_color || '#ffffff');
            addStyleField('Colore Sfondo Bottone', 'button_bg_color', 'color', currentStyles.button_bg_color || '#ff9800');
            
            // Layout styling
            const layoutStyleSection = document.createElement('div');
            layoutStyleSection.innerHTML = '<h4 style="margin-top: 20px; margin-bottom: 15px; font-size: 14px; font-weight: 600; color: #555;">‚öôÔ∏è Layout</h4>';
            fieldsContainer.appendChild(layoutStyleSection);
            
            addStyleField('Padding', 'padding', 'text', currentStyles.padding || '40px');
            addStyleField('Gap tra elementi', 'image_gap', 'text', currentStyles.image_gap || '40px');
            
            renderCanvas();
            return;
        }
        
        // CONTENUTO PER ALTRI BLOCCHI (image, text, title)
        // Campi Contenuto
        const contentGroup = document.createElement('div');
        contentGroup.className = 'form-group';
        
        const contentLabel = document.createElement('label');
        contentLabel.innerText = "Contenuto " + (block.type === 'image' ? 'URL' : 'Testo');
        contentGroup.appendChild(contentLabel);

        if (block.type === 'image') {
            const contentInput = document.createElement('input');
            contentInput.className = 'form-control';
            contentInput.value = block.content.url || '';
            contentInput.oninput = (e) => {
                block.content.url = e.target.value;
                renderCanvas();
            };
            contentGroup.appendChild(contentInput);

            const uploadBtn = document.createElement('input');
            uploadBtn.type = 'file';
            uploadBtn.style.marginTop = '10px';
            uploadBtn.style.fontSize = '0.8rem';
            uploadBtn.onchange = (e) => handleUpload(e, index);
            contentGroup.appendChild(uploadBtn);
        } else {
            // Usa TinyMCE per text e title
            const textareaId = 'wysiwyg-' + index + '-' + Date.now();
            const textarea = document.createElement('textarea');
            textarea.id = textareaId;
            textarea.className = 'form-control';
            textarea.value = block.content.text || '';
            textarea.style.minHeight = '200px';
            contentGroup.appendChild(textarea);

            // Inizializza TinyMCE dopo che l'elemento √® nel DOM e TinyMCE √® caricato
            setTimeout(() => {
                if (typeof tinymce === 'undefined') {
                    console.error('TinyMCE non √® ancora caricato');
                    // Fallback: usa textarea normale
                    textarea.oninput = (e) => {
                        block.content.text = e.target.value;
                        renderCanvas();
                    };
                    return;
                }
                
                tinymce.init({
                    selector: '#' + textareaId,
                    menubar: false,
                    plugins: 'lists link image',
                    toolbar: 'undo redo | formatselect | bold italic | bullist numlist | link image',
                    height: 250,
                    setup: function(editor) {
                        editor.on('change keyup', function() {
                            block.content.text = editor.getContent();
                            renderCanvas();
                        });
                    }
                });
            }, 100);
        }
        fieldsContainer.appendChild(contentGroup);

        fieldsContainer.appendChild(document.createElement('hr'));

        // Campi Stile
        const currentStyles = block.settings[currentView] || {};

        // Font controls only for title/text blocks
        if (block.type === 'title' || block.type === 'text') {
            addStyleField('Font Family', 'font_family', 'select', currentStyles.font_family || 'roboto', Object.keys(fonts));
            
            const fontKey = currentStyles.font_family || 'roboto';
            const weights = getAvailableWeights(fontKey);
            addStyleField('Font Weight', 'font_weight', 'select', currentStyles.font_weight || '400', weights.map(String));
            
            addStyleFieldWithRange('Dimensione Font', 'font_size', currentStyles.font_size || '16px', 12, 72);
            addStyleField('Letter Spacing', 'letter_spacing', 'text', currentStyles.letter_spacing || '0px');
            addStyleField('Word Spacing', 'word_spacing', 'text', currentStyles.word_spacing || '0px');
        }

        addStyleField('Colore Testo', 'color', 'color', currentStyles.color || '#333333');
        addStyleField('Allineamento', 'align', 'select', currentStyles.align || 'left', ['left', 'center', 'right']);
        addStyleField('Padding', 'padding', 'text', currentStyles.padding || '');

        renderCanvas();
    }

    function addStyleFieldWithRange(label, prop, value, min, max) {
        const div = document.createElement('div');
        div.className = 'form-group';
        
        const l = document.createElement('label');
        l.innerText = label;
        div.appendChild(l);

        const wrapper = document.createElement('div');
        wrapper.className = 'range-slider';
        
        // Extract numeric value
        const numValue = parseInt(value) || min;
        const sliderId = 'slider-' + prop + '-' + Date.now();
        
        const slider = document.createElement('input');
        slider.type = 'range';
        slider.id = sliderId;
        slider.min = min;
        slider.max = max;
        slider.value = numValue;
        slider.setAttribute('aria-label', label);
        slider.setAttribute('aria-valuenow', numValue);
        slider.setAttribute('aria-valuemin', min);
        slider.setAttribute('aria-valuemax', max);
        slider.setAttribute('aria-valuetext', numValue + 'px');
        
        const display = document.createElement('div');
        display.className = 'range-value';
        display.innerText = numValue + 'px';
        display.setAttribute('aria-live', 'polite');
        display.setAttribute('aria-atomic', 'true');
        
        slider.oninput = (e) => {
            const newValue = e.target.value;
            display.innerText = newValue + 'px';
            slider.setAttribute('aria-valuenow', newValue);
            slider.setAttribute('aria-valuetext', newValue + 'px');
            updateStyle(prop, newValue + 'px');
        };
        
        wrapper.appendChild(slider);
        wrapper.appendChild(display);
        div.appendChild(wrapper);
        fieldsContainer.appendChild(div);
    }

    function addStyleField(label, prop, type, value, options = []) {
        const div = document.createElement('div');
        div.className = 'form-group';
        
        const l = document.createElement('label');
        l.innerText = label;
        div.appendChild(l);

        if (type === 'color') {
            const wrapper = document.createElement('div');
            wrapper.className = 'color-input-wrapper';
            
            const preview = document.createElement('div');
            preview.className = 'color-preview';
            preview.style.background = value;
            preview.setAttribute('aria-label', `Preview del colore ${value}`);
            
            const picker = document.createElement('input');
            picker.type = 'color';
            picker.value = value.startsWith('#') ? value : '#000000';
            picker.style.position = 'absolute';
            picker.style.opacity = '0';
            picker.style.width = '30px';
            picker.style.height = '30px';
            picker.style.cursor = 'pointer';
            picker.setAttribute('aria-label', label + ' - Selettore colore');
            
            const text = document.createElement('input');
            text.className = 'color-input-field';
            text.value = value;
            text.setAttribute('aria-label', label + ' - Valore esadecimale');
            text.setAttribute('title', 'Inserisci un colore hex (es: #FF0000)');
            
            picker.oninput = (e) => {
                text.value = e.target.value;
                preview.style.background = e.target.value;
                preview.setAttribute('aria-label', `Preview del colore ${e.target.value}`);
                updateStyle(prop, e.target.value);
            };
            
            text.oninput = (e) => {
                preview.style.background = e.target.value;
                preview.setAttribute('aria-label', `Preview del colore ${e.target.value}`);
                updateStyle(prop, e.target.value);
            };
            
            wrapper.appendChild(picker);
            wrapper.appendChild(preview);
            wrapper.appendChild(text);
            div.appendChild(wrapper);
        } else if (type === 'select') {
            const input = document.createElement('select');
            input.className = 'form-control';
            input.setAttribute('aria-label', label);
            options.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o;
                // Pretty display names for fonts
                if (prop === 'font_family') {
                    const fontNames = { roboto: 'Roboto', poppins: 'Poppins', inter: 'Inter', playfair: 'Playfair Display' };
                    opt.innerText = fontNames[o] || o;
                } else {
                    opt.innerText = o;
                }
                if (o === value) opt.selected = true;
                input.appendChild(opt);
            });
            input.onchange = (e) => {
                updateStyle(prop, e.target.value);
                // Se cambio font, aggiorna i weight disponibili
                if (prop === 'font_family') {
                    openSettings(activeBlockIndex);
                }
            };
            div.appendChild(input);
        } else {
            const input = document.createElement('input');
            input.type = type;
            input.value = value;
            input.className = 'form-control';
            input.setAttribute('aria-label', label);
            if (type === 'text') {
                input.setAttribute('title', 'Formato: numero + unit√† (es: 10px, 1.5em)');
            }
            input.oninput = (e) => updateStyle(prop, e.target.value);
            div.appendChild(input);
        }
        
        fieldsContainer.appendChild(div);
    }

    function updateStyle(prop, value) {
        if (!blocks[activeBlockIndex].settings[currentView]) {
            blocks[activeBlockIndex].settings[currentView] = {};
        }
        blocks[activeBlockIndex].settings[currentView][prop] = value;
        renderCanvas();
    }

    async function handleUpload(e, index) {
        const file = e.target.files[0];
        if (!file) return;

        // Validazione file
        const maxSize = 5 * 1024 * 1024; // 5MB
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        
        if (file.size > maxSize) {
            notify('error', '‚ùå Upload Fallito', `Immagine troppo grande (max 5MB). La tua: ${(file.size / 1024 / 1024).toFixed(2)}MB`);
            return;
        }
        
        if (!allowedTypes.includes(file.type)) {
            notify('error', '‚ùå Upload Fallito', `Formato non supportato. Supportati: JPEG, PNG, GIF, WebP`);
            return;
        }

        notify('info', '‚è≥ Upload in corso...', `Caricamento di ${file.name}...`, 0);

        const formData = new FormData();
        formData.append('file', file);

        try {
            const res = await fetch('/admin/cms/upload', {
                method: 'POST',
                body: formData
            });
            
            if (!res.ok) {
                const errorData = await res.json();
                notify('error', '‚ùå Upload Fallito', errorData.message || 'Errore durante il caricamento');
                return;
            }
            
            const data = await res.json();
            
            // Add cache-busting
            const timestamp = new Date().getTime();
            blocks[index].content.url = data.path + '?v=' + timestamp;
            
            renderCanvas();
            openSettings(index);
            notify('success', '‚úÖ Upload Completato', `Immagine ${file.name} caricata con successo`);
        } catch (err) {
            console.error('Upload error:', err);
            notify('error', '‚ùå Upload Fallito', 'Errore di connessione: ' + err.message);
        }
    }

    async function savePage() {
        notify('info', '‚è≥ Salvataggio...', 'Sto salvando la pagina...', 0);
        
        try {
            const res = await fetch(`/admin/cms/builder/${pageId}/save`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ blocks: blocks })
            });
            
            const data = await res.json();
            
            if (res.ok) {
                notify('success', '‚úÖ Salvato', data.message || 'Pagina salvata con successo');
            } else {
                let errorMsg = data.message || 'Errore durante il salvataggio';
                if (data.errors) {
                    errorMsg += '\n\n' + Object.values(data.errors).flat().join('\n');
                }
                notify('error', '‚ùå Errore Salvataggio', errorMsg);
            }
        } catch (err) {
            console.error('Save error:', err);
            notify('error', '‚ùå Errore Salvataggio', 'Errore di connessione: ' + err.message);
        }
    }

    async function publishPage() {
        const publishBtn = document.getElementById('publish-btn');
        const publishText = document.getElementById('publish-text');
        const publishIcon = document.getElementById('publish-icon');
        
        if (pageStatus === 'published') {
            // Metti in bozza
            if (isHomepage) {
                notify('warning', '‚ö†Ô∏è Azione Non Consentita', 'Non √® possibile mettere in bozza la homepage. Imposta prima un\'altra pagina come homepage.');
                return;
            }
            
            if (!confirm('Sei sicuro di voler mettere questa pagina in bozza?')) return;

            notify('info', '‚è≥ Elaborazione...', 'Sto mettendo la pagina in bozza...', 0);

            try {
                const res = await fetch(`/admin/cms/${pageId}/unpublish`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await res.json();
                
                if (res.ok && data.status === 'success') {
                    pageStatus = 'draft';
                    publishText.innerText = 'Pubblica Pagina';
                    publishIcon.innerText = 'üì§';
                    publishBtn.classList.remove('btn-draft');
                    publishBtn.classList.add('btn-publish');
                    
                    notify('success', '‚úÖ Archiviata', 'Pagina messa in bozza con successo');
                } else {
                    notify('error', '‚ùå Errore', data.message || 'Errore nel mettere in bozza la pagina');
                }
            } catch (err) {
                console.error('Unpublish error:', err);
                notify('error', '‚ùå Errore Connessione', err.message);
            }
        } else {
            // Pubblica
            if (!confirm('Sei sicuro di voler pubblicare questa pagina?')) return;

            notify('info', '‚è≥ Elaborazione...', 'Sto pubblicando la pagina...', 0);

            try {
                const res = await fetch(`/admin/cms/${pageId}/publish`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    pageStatus = 'published';
                    publishText.innerText = 'Metti in Bozza';
                    publishIcon.innerText = 'üìã';
                    publishBtn.classList.remove('btn-publish');
                    publishBtn.classList.add('btn-draft');
                    
                    notify('success', '‚úÖ Pubblicata', 'Pagina pubblicata con successo!');
                } else {
                    notify('error', '‚ùå Errore', data.message || 'Errore nel pubblicare la pagina');
                }
            } catch (err) {
                console.error('Publish error:', err);
                notify('error', '‚ùå Errore Connessione', err.message);
            }
        }
    }

    async function setHomepage() {
        if (!confirm('Sei sicuro di voler impostare questa pagina come homepage?')) {
            document.getElementById('set-homepage').checked = false;
            return;
        }

        notify('info', '‚è≥ Elaborazione...', 'Sto impostando questa pagina come homepage...', 0);

        try {
            const res = await fetch(`/admin/cms/${pageId}/set-homepage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            const data = await res.json();
            
            if (res.ok) {
                isHomepage = true;
                document.getElementById('set-homepage').disabled = true;
                notify('success', '‚úÖ Homepage Impostata', 'Questa pagina √® ora la homepage!');
            } else {
                document.getElementById('set-homepage').checked = false;
                notify('error', '‚ùå Errore', data.message || 'Errore nell\'impostare la homepage');
            }
        } catch (err) {
            console.error('Set homepage error:', err);
            document.getElementById('set-homepage').checked = false;
            notify('error', '‚ùå Errore Connessione', err.message);
        }
    }

    init();
</script>
{% endblock %}
